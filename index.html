<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELT Map - Social Enterprise Legislative Tracker</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Frank+Ruhl+Libre:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #00abce 0%, #73a535 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .grunin-branding {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 30px;
            margin-bottom: 30px;
        }

        .grunin-logo-img {
            width: 300px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            padding: 20px;
        }

        .grunin-title {
            text-align: left;
            flex: 1;
        }

        .grunin-name {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grunin-subtitle {
            font-size: 1.3em;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            font-family: 'Frank Ruhl Libre', serif;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        
        /* Content Sections */
        .content-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .content-section h2 {
            font-size: 1.8em;
            color: #925333;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 3px solid #00abce;
            padding-bottom: 10px;
        }

        .content-section p {
            font-size: 1.05em;
            line-height: 1.7;
            color: #333;
            margin-bottom: 15px;
            font-family: 'Frank Ruhl Libre', serif;
        }
        
        .content-section p strong {
            color: #925333;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Map Container - Everything in one unified box */
        .map-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Year Toggle and Legend at Top */
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .year-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-control label {
            font-weight: 600;
            color: #925333;
            font-size: 14px;
        }

        #yearSelect {
            padding: 8px 15px;
            border: 2px solid #73a535;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        #yearSelect:hover {
            border-color: #00abce;
        }

        /* Emoji Legend */
        .emoji-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #666;
        }

        .legend-emoji {
            font-size: 16px;
        }

        /* Map and Bar Graph Layout */
        .map-viz-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* SVG Map */
        .map-wrapper {
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            overflow: visible;
        }

        #us-map {
            width: 100%;
            height: auto;
            display: block;
        }

        /* State styles */
        .state-path {
            fill: #e8e8e8;
            stroke: #999;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .state-path:hover {
            fill: #d0e8ff;
            stroke: #00abce;
            stroke-width: 3;
        }

        /* State labels */
        .state-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 10px;
            font-weight: 700;
            pointer-events: none;
            user-select: none;
            fill: #333;
        }

        /* Bar Graph */
        .bar-graph-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .bar-graph-title {
            text-align: center;
            font-size: 14px;
            color: #925333;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .bar-graph {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            gap: 10px;
            height: 180px;
            padding: 10px 0;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .bar-item:hover {
            transform: translateY(-3px);
        }

        .bar-count {
            font-size: 18px;
            font-weight: 700;
            color: #925333;
            margin-bottom: 5px;
        }

        .bar-visual {
            width: 100%;
            background: linear-gradient(to top, #00abce, #73a535);
            border-radius: 8px 8px 0 0;
            min-height: 20px;
            transition: all 0.3s;
        }

        .bar-item:hover .bar-visual {
            background: linear-gradient(to top, #925333, #73a535);
        }

        .bar-label {
            margin-top: 8px;
            text-align: center;
        }

        .bar-form-code {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .bar-state-count {
            font-size: 11px;
            color: #666;
        }

        .bar-hint {
            font-size: 10px;
            color: #00abce;
            margin-top: 2px;
        }

        /* State Popup Modal */
        .state-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1001;
        }

        .state-popup.active {
            display: block;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .popup-overlay.active {
            display: block;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00abce;
        }

        .popup-header h3 {
            font-size: 1.8em;
            color: #925333;
        }

        .popup-close {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .popup-close:hover {
            transform: scale(1.1);
        }

        .popup-content p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .popup-content strong {
            color: #925333;
        }

        .popup-button {
            display: inline-block;
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .popup-button:hover {
            transform: translateY(-2px);
        }

        /* Reports Section Layout */
        .reports-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 25px;
        }

        .reports-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .report-subsection {
            background: rgba(0, 171, 206, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #00abce;
        }

        .report-subsection h3 {
            color: #925333;
            font-size: 1.3em;
            margin-bottom: 12px;
        }

        .report-link {
            display: inline-block;
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 500;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .report-link:hover {
            transform: translateY(-2px);
        }

        .reports-right {
            background: rgba(115, 165, 53, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #73a535;
        }

        .reports-right h3 {
            color: #925333;
            font-size: 1.3em;
            margin-bottom: 12px;
        }

        .tepper-link {
            display: inline-block;
            color: #00abce;
            font-weight: 500;
            text-decoration: none;
            margin-top: 10px;
        }

        .tepper-link:hover {
            text-decoration: underline;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .grunin-branding {
                flex-direction: column;
                text-align: center;
            }

            .grunin-logo-img {
                width: 200px;
            }

            .grunin-title {
                text-align: center;
            }

            .grunin-name {
                font-size: 1.4em;
            }

            .grunin-subtitle {
                font-size: 1.1em;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content-section {
                padding: 20px;
            }

            .content-section h2 {
                font-size: 1.4em;
            }

            .map-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .emoji-legend {
                width: 100%;
                justify-content: space-between;
            }

            .legend-item {
                font-size: 11px;
            }

            .map-viz-layout {
                gap: 15px;
            }

            .bar-graph {
                height: 150px;
            }

            .bar-count {
                font-size: 14px;
            }

            .bar-form-code {
                font-size: 12px;
            }

            .bar-state-count {
                font-size: 10px;
            }

            .reports-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .state-popup {
                padding: 20px;
                max-width: 95%;
            }

            .popup-header h3 {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="grunin-branding">
                <img src="grunin-logo.png" alt="Grunin Center Logo" class="grunin-logo-img" onerror="this.style.display='none'">
                <div class="grunin-title">
                    <div class="grunin-name">Grunin Center for Law and Social Entrepreneurship</div>
                    <div class="grunin-subtitle">NYU School of Law</div>
                </div>
            </div>
            <h1>Social Enterprise Legislative Tracker</h1>
        </div>

        <!-- About Section -->
        <div class="content-section">
            <h2>About</h2>
            <p>Welcome to the Social Enterprise Law Tracker ("SELT"). Beginning in 2008, state legislatures started authorizing a new class of entities collectively known as <em>social enterprises</em>. These corporate and company forms are designed for businesses that seek to create positive social and environmental impacts in addition to financial returns. These forms include the benefit corporation (Benefit Corps), the social purpose corporation (SPC), the low-profit limited liability company (L3C), the benefit limited liability company (BLLC), and the statutory public benefit limited partnership (SPBLP).</p>
            
            <p>The SELT visualizes how social enterprise law has spread across the US. Select any state to see the social enterprise forms that are available, and historic legislative activity.</p>
            
            <p>The SELT was developed by Rob Esposito and Shawn Pelsinger, with support from the NYU Jacobson Leadership Program in Law & Business, the NYU Stern Business & Society Program, and the NYU Law and Social Entrepreneurship Association. The SELT is now hosted and maintained by the Grunin Center for Law and Social Entrepreneurship.</p>
        </div>

        <!-- Corporate Forms Definitions Section -->
        <div class="content-section">
            <h2>Social Enterprise Corporate Forms Defined</h2>
            <p>The SELT tracks the following five corporate forms, each designed to support businesses pursuing both profit and positive social or environmental impact:</p>
            
            <p><strong>Benefit Corporation (BCORP)</strong> is the most widely adopted form, requiring companies to pursue general public benefit alongside profit. Directors must consider stakeholder interests beyond shareholders in decision-making.</p>
            
            <p><strong>Social Purpose Corporation (SPC)</strong> allows corporations to define specific social or environmental purposes in addition to profit maximization. It provides flexibility in how companies balance financial and social objectives.</p>
            
            <p><strong>Low-profit Limited Liability Company (L3C)</strong> is designed primarily for charitable purposes with limited profit distribution. It was originally created to facilitate program-related investments (PRIs) by foundations.</p>
            
            <p><strong>Benefit Limited Liability Company (BLLC)</strong> combines the flexibility of LLC structure with benefit corporation principles. It offers LLC tax treatment with social benefit requirements.</p>
            
            <p><strong>Social Purpose Benefit Limited Partnership (SPBLP)</strong> provides a limited partnership structure for social enterprises, particularly suited for impact investing arrangements.</p>
        </div>

        <!-- Map Container - Everything in One Unified Box -->
        <div class="map-container">
            <!-- Year Toggle and Emoji Key -->
            <div class="map-controls">
                <div class="year-control">
                    <label for="yearSelect">Year:</label>
                    <select id="yearSelect">
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                <div class="emoji-legend">
                    <div class="legend-item">
                        <span class="legend-emoji">‚ö™</span>
                        <span>No Activity</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-emoji">‚úÖ</span>
                        <span>Enacted Form(s)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-emoji">‚ùå</span>
                        <span>Failed Legislation</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-emoji">‚è≥</span>
                        <span>Under Consideration</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-emoji">‚õî</span>
                        <span>Repealed</span>
                    </div>
                </div>
            </div>

            <!-- Map and Bar Graph Layout -->
            <div class="map-viz-layout">
                <!-- US Map -->
                <div class="map-wrapper">
                    <svg id="us-map" viewBox="0 0 960 600" xmlns="http://www.w3.org/2000/svg">
                        <!-- Map will be populated by JavaScript -->
                    </svg>
                </div>

                <!-- Bar Graph -->
                <div class="bar-graph-section">
                    <div class="bar-graph" id="barGraph">
                        <!-- Bars populated by JavaScript -->
                    </div>
                    <div class="bar-graph-title">Forms Active in This Year</div>
                </div>
            </div>
        </div>

        <!-- Reports Section with New Layout -->
        <div class="content-section">
            <h2>Annual Reports: The State of Social Enterprise and the Law</h2>
            <div class="reports-layout">
                <!-- Left Column -->
                <div class="reports-left">
                    <div class="report-subsection">
                        <p>The Grunin Center publishes comprehensive annual reports tracking US social enterprise legislative developments from 2009 to the present.</p>
                    </div>
                    
                    <div class="report-subsection">
                        <h3>üìä Access All Reports and Publications</h3>
                        <a href="https://www.law.nyu.edu/centers/grunin-social-entrepreneurship/resources/publications" target="_blank" class="report-link">
                            View Reports ‚Üí
                        </a>
                    </div>
                    
                    <div class="report-subsection">
                        <h3>Acknowledgment</h3>
                        <p>This research project is generously funded by the Tepper Family. We would like to extend our gratitude to the Tepper Family, with particular thanks to Marvin Tepper '58, Elise Tepper, Jacqueline Tepper '90, Edward Tepper, and Shelley Tepper.</p>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="reports-right">
                    <h3>About the Tepper Fellows</h3>
                    <p>Each year, the Grunin Center selects up to five student Research Assistants as Tepper Fellows. These Fellows maintain the Social Enterprise Law Tracker and author the annual reports.</p>
                    <a href="https://www.law.nyu.edu/centers/grunin-social-entrepreneurship/courses-programs/tepper-fellows" target="_blank" class="tepper-link">
                        Learn more about our current Tepper Fellows ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- State Popup Modal -->
    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="state-popup" id="statePopup">
        <div class="popup-header">
            <h3 id="popupTitle"></h3>
            <button class="popup-close" id="popupClose">√ó</button>
        </div>
        <div class="popup-content" id="popupContent">
            <!-- Content populated by JavaScript -->
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/map-data.js"></script>
    <script>
        // Simplified US map with visible state boundaries using rectangles/polygons
        // This creates a recognizable US map shape without complex SVG paths
        
        const statePositions = {
            // Format: { x, y, width, height, name }
            // Western states
            'WA': { x: 50, y: 50, w: 80, h: 60, name: 'Washington' },
            'OR': { x: 50, y: 115, w: 70, h: 70, name: 'Oregon' },
            'CA': { x: 40, y: 190, w: 70, h: 150, name: 'California' },
            'ID': { x: 135, y: 80, w: 60, h: 100, name: 'Idaho' },
            'NV': { x: 115, y: 180, w: 70, h: 90, name: 'Nevada' },
            'MT': { x: 200, y: 50, w: 100, h: 70, name: 'Montana' },
            'WY': { x: 210, y: 125, w: 80, h: 75, name: 'Wyoming' },
            'UT': { x: 180, y: 205, w: 70, h: 75, name: 'Utah' },
            'AZ': { x: 165, y: 285, w: 80, h: 80, name: 'Arizona' },
            'NM': { x: 250, y: 280, w: 75, h: 85, name: 'New Mexico' },
            'CO': { x: 260, y: 195, w: 80, h: 80, name: 'Colorado' },
            
            // Central states
            'ND': { x: 305, y: 60, w: 75, h: 60, name: 'North Dakota' },
            'SD': { x: 305, y: 125, w: 75, h: 60, name: 'South Dakota' },
            'NE': { x: 310, y: 190, w: 75, h: 55, name: 'Nebraska' },
            'KS': { x: 315, y: 250, w: 75, h: 55, name: 'Kansas' },
            'OK': { x: 330, y: 310, w: 75, h: 50, name: 'Oklahoma' },
            'TX': { x: 320, y: 365, w: 90, h: 120, name: 'Texas' },
            
            // Upper Midwest
            'MN': { x: 385, y: 90, w: 70, h: 80, name: 'Minnesota' },
            'IA': { x: 390, y: 175, w: 70, h: 55, name: 'Iowa' },
            'MO': { x: 390, y: 235, w: 70, h: 70, name: 'Missouri' },
            'WI': { x: 460, y: 100, w: 60, h: 70, name: 'Wisconsin' },
            'IL': { x: 455, y: 175, w: 50, h: 100, name: 'Illinois' },
            'MI': { x: 520, y: 110, w: 70, h: 90, name: 'Michigan' },
            'IN': { x: 510, y: 180, w: 45, h: 75, name: 'Indiana' },
            'OH': { x: 560, y: 170, w: 60, h: 70, name: 'Ohio' },
            
            // South
            'AR': { x: 410, y: 310, w: 50, h: 55, name: 'Arkansas' },
            'LA': { x: 415, y: 370, w: 50, h: 60, name: 'Louisiana' },
            'MS': { x: 465, y: 325, w: 40, h: 80, name: 'Mississippi' },
            'AL': { x: 510, y: 325, w: 45, h: 85, name: 'Alabama' },
            'TN': { x: 505, y: 260, w: 80, h: 55, name: 'Tennessee' },
            'KY': { x: 555, y: 240, w: 75, h: 45, name: 'Kentucky' },
            'GA': { x: 560, y: 320, w: 55, h: 80, name: 'Georgia' },
            'FL': { x: 600, y: 380, w: 70, h: 100, name: 'Florida' },
            'SC': { x: 620, y: 305, w: 50, h: 50, name: 'South Carolina' },
            'NC': { x: 630, y: 260, w: 70, h: 45, name: 'North Carolina' },
            
            // East
            'WV': { x: 625, y: 230, w: 45, h: 50, name: 'West Virginia' },
            'VA': { x: 670, y: 245, w: 65, h: 45, name: 'Virginia' },
            'PA': { x: 670, y: 185, w: 70, h: 50, name: 'Pennsylvania' },
            'NY': { x: 720, y: 140, w: 65, h: 65, name: 'New York' },
            'MD': { x: 735, y: 235, w: 35, h: 25, name: 'Maryland' },
            'DE': { x: 770, y: 220, w: 15, h: 35, name: 'Delaware' },
            'NJ': { x: 750, y: 200, w: 25, h: 40, name: 'New Jersey' },
            
            // New England  
            'VT': { x: 765, y: 125, w: 25, h: 45, name: 'Vermont' },
            'NH': { x: 790, y: 120, w: 25, h: 50, name: 'New Hampshire' },
            'ME': { x: 800, y: 70, w: 45, h: 80, name: 'Maine' },
            'MA': { x: 790, y: 160, w: 40, h: 25, name: 'Massachusetts' },
            'RI': { x: 815, y: 170, w: 15, h: 15, name: 'Rhode Island' },
            'CT': { x: 780, y: 180, w: 30, h: 20, name: 'Connecticut' },
            
            // Non-contiguous
            'AK': { x: 60, y: 450, w: 80, h: 60, name: 'Alaska' },
            'HI': { x: 200, y: 470, w: 50, h: 35, name: 'Hawaii' }
        };

        class SELTMapApp {
            constructor() {
                this.currentYear = 2024;
                this.stateElements = {};
                this.init();
            }

            init() {
                this.setupYearSelect();
                this.drawMap();
                this.updateDisplay();
                this.setupPopup();
            }

            setupYearSelect() {
                const yearSelect = document.getElementById('yearSelect');
                for (let year = 2024; year >= 2008; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }

                yearSelect.addEventListener('change', (e) => {
                    this.currentYear = parseInt(e.target.value);
                    this.updateDisplay();
                });
            }

            drawMap() {
                const svg = document.getElementById('us-map');
                svg.setAttribute('viewBox', '0 0 900 550');
                
                // Draw each state as a rectangle with label
                Object.entries(statePositions).forEach(([code, pos]) => {
                    // Create state rectangle
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', pos.x);
                    rect.setAttribute('y', pos.y);
                    rect.setAttribute('width', pos.w);
                    rect.setAttribute('height', pos.h);
                    rect.setAttribute('class', 'state-path');
                    rect.setAttribute('data-state', code);
                    rect.setAttribute('rx', '3');
                    rect.addEventListener('click', () => this.showStatePopup(code));
                    svg.appendChild(rect);

                    // Create text label (code + emoji)
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', pos.x + pos.w/2);
                    text.setAttribute('y', pos.y + pos.h/2 + 4);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('class', 'state-label');
                    text.setAttribute('id', `label-${code}`);
                    text.textContent = code;
                    svg.appendChild(text);
                    
                    this.stateElements[code] = { rect, text };
                });
            }

            updateDisplay() {
                // Update map labels with emojis
                Object.keys(statePositions).forEach(code => {
                    const activity = getStateActivity(code, this.currentYear);
                    const label = document.getElementById(`label-${code}`);
                    if (label) {
                        // Determine emoji based on activity
                        let emoji = '‚ö™';
                        if (activity.rescinded && activity.rescinded.length > 0) {
                            emoji = '‚õî';
                        } else if (activity.forms && activity.forms.length > 0) {
                            emoji = '‚úÖ';
                        } else if (activity.underConsideration && activity.underConsideration.length > 0) {
                            emoji = '‚è≥';
                        } else if (activity.failed && activity.failed.length > 0) {
                            emoji = '‚ùå';
                        }
                        
                        label.textContent = `${code} ${emoji}`;
                    }
                });

                // Update bar graph
                this.updateBarGraph();
            }

            updateBarGraph() {
                const barGraph = document.getElementById('barGraph');
                if (!barGraph) return;
                
                barGraph.innerHTML = '';

                // Calculate cumulative counts up to current year
                const formCounts = { BCORP: 0, L3C: 0, BLLC: 0, SPC: 0, SPBLP: 0 };
                
                Object.keys(statePositions).forEach(code => {
                    const activity = getStateActivity(code, this.currentYear);
                    if (activity.availableForms) {
                        activity.availableForms.forEach(form => {
                            if (formCounts[form] !== undefined) {
                                formCounts[form]++;
                            }
                        });
                    }
                });

                // Sort by count
                const sortedForms = Object.entries(formCounts)
                    .filter(([_, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1]);

                if (sortedForms.length === 0) {
                    barGraph.innerHTML = '<div style="text-align: center; color: #999; padding: 20px; width: 100%;">No forms enacted by this year</div>';
                    return;
                }

                const maxCount = sortedForms[0][1];

                sortedForms.forEach(([form, count]) => {
                    const height = Math.max(20, (count / maxCount) * 140);
                    const stateText = count === 1 ? '1 state' : `${count} states`;

                    const barItem = document.createElement('div');
                    barItem.className = 'bar-item';
                    barItem.onclick = () => window.location.href = `forms/${form.toLowerCase()}.html`;
                    
                    barItem.innerHTML = `
                        <div class="bar-count">${count}</div>
                        <div class="bar-visual" style="height: ${height}px;"></div>
                        <div class="bar-label">
                            <div class="bar-form-code">${form}</div>
                            <div class="bar-state-count">${stateText}</div>
                            <div class="bar-hint">Click for timeline ‚Üí</div>
                        </div>
                    `;
                    
                    barGraph.appendChild(barItem);
                });
            }

            setupPopup() {
                const overlay = document.getElementById('popupOverlay');
                const popup = document.getElementById('statePopup');
                const closeBtn = document.getElementById('popupClose');

                overlay.addEventListener('click', () => this.closePopup());
                closeBtn.addEventListener('click', () => this.closePopup());
            }

            showStatePopup(stateCode) {
                const pos = statePositions[stateCode];
                const activity = getStateActivity(stateCode, this.currentYear);
                
                const popup = document.getElementById('statePopup');
                const overlay = document.getElementById('popupOverlay');
                const title = document.getElementById('popupTitle');
                const content = document.getElementById('popupContent');

                title.textContent = `${pos.name} - ${this.currentYear}`;

                let html = `<p><strong>Year:</strong> ${this.currentYear}</p>`;

                if (activity.forms && activity.forms.length > 0) {
                    html += `<p><strong>Enacted Forms:</strong></p><ul>`;
                    activity.forms.forEach(form => {
                        const formName = { 
                            'BCORP': 'Benefit Corporation',
                            'L3C': 'Low-profit Limited Liability Company',
                            'BLLC': 'Benefit Limited Liability Company',
                            'SPC': 'Social Purpose Corporation',
                            'SPBLP': 'Social Purpose Benefit Limited Partnership'
                        }[form] || form;
                        html += `<li>${form} - ${formName}</li>`;
                    });
                    html += `</ul>`;
                }

                if (activity.failed && activity.failed.length > 0) {
                    html += `<p><strong>Failed Legislation:</strong></p><ul>`;
                    activity.failed.forEach(form => html += `<li>${form}</li>`);
                    html += `</ul>`;
                }

                if (activity.rescinded && activity.rescinded.length > 0) {
                    html += `<p><strong>Rescinded Forms:</strong></p><ul>`;
                    activity.rescinded.forEach(form => html += `<li>${form}</li>`);
                    html += `</ul>`;
                }

                if (activity.underConsideration && activity.underConsideration.length > 0) {
                    html += `<p><strong>Under Consideration:</strong></p><ul>`;
                    activity.underConsideration.forEach(form => html += `<li>${form}</li>`);
                    html += `</ul>`;
                }

                if ((!activity.forms || activity.forms.length === 0) && 
                    (!activity.failed || activity.failed.length === 0) && 
                    (!activity.rescinded || activity.rescinded.length === 0) && 
                    (!activity.underConsideration || activity.underConsideration.length === 0)) {
                    html += `<p><em>No legislative activity this year</em></p>`;
                }

                html += `<a href="states/${stateCode.toLowerCase()}.html" class="popup-button">View Complete Legislative History</a>`;

                content.innerHTML = html;
                popup.classList.add('active');
                overlay.classList.add('active');
            }

            closePopup() {
                document.getElementById('statePopup').classList.remove('active');
                document.getElementById('popupOverlay').classList.remove('active');
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new SELTMapApp();
        });
    </script>
</body>
</html>
