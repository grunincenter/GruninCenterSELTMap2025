<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>SELT Map - Social Enterprise Legislative Tracker</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Frank+Ruhl+Libre:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #00abce 0%, #73a535 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .grunin-branding {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 30px;
            margin-bottom: 30px;
            width: 100%;
        }

        .grunin-logo-img {
            width: 300px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: white;
            padding: 20px;
        }

        .grunin-title {
            text-align: left;
            flex: 1;
        }

        .grunin-name {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .grunin-subtitle {
            font-size: 1.3em;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            font-family: 'Frank Ruhl Libre', serif;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        
        /* Content Sections */
        .content-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .content-section h2 {
            font-size: 1.8em;
            color: #925333;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 3px solid #00abce;
            padding-bottom: 10px;
        }

        .content-section p {
            font-size: 1.05em;
            line-height: 1.7;
            color: #333;
            margin-bottom: 15px;
            font-family: 'Frank Ruhl Libre', serif;
        }
        
        .content-section p strong {
            color: #925333;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Map Section with Enhanced Controls */
        .map-section {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            position: relative;
        }
        
        .map-controls {
            background: linear-gradient(to bottom, #f8f9fa, #ffffff);
            padding: 20px;
            border-bottom: 2px solid #00abce;
        }
        
        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-label {
            font-weight: 600;
            color: #925333;
            font-size: 14px;
        }
        
        /* Selects and Buttons */
        select, button {
            padding: 8px 15px;
            border: 2px solid #73a535;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }
        
        select:hover, button:hover {
            border-color: #00abce;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        select:focus, button:focus {
            outline: none;
            border-color: #00abce;
            box-shadow: 0 0 0 3px rgba(0, 171, 206, 0.2);
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        
        /* Map Layout */
        .map-content {
            height: 600px;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #e6f3f7;
            position: relative;
        }
        
        /* Hide the old state details section below map */
        .state-details-section {
            display: none;
        }
        
        /* Modal Overlay for State Details */
        .state-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .state-modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal Content */
        .state-modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        /* Modal Header */
        .state-modal-header {
            background: linear-gradient(135deg, #00abce 0%, #73a535 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .state-modal-title {
            font-size: 1.8em;
            font-weight: 700;
        }

        .state-modal-year {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .state-modal-close {
            background: transparent;
            border: 2px solid white;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .state-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* Modal Body */
        .state-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-detail-section {
            margin-bottom: 25px;
        }

        .modal-detail-title {
            font-weight: 600;
            color: #00abce;
            font-size: 1.2em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-form-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .modal-form-item {
            padding: 8px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-left: 4px solid #73a535;
            border-radius: 4px;
        }

        .modal-form-item.pending {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .modal-form-item.failed {
            border-left-color: #e74c3c;
            background: #fdeaea;
        }

        .modal-empty-state {
            color: #999;
            font-style: italic;
            padding: 10px;
        }

        .modal-history-btn {
            background: linear-gradient(135deg, #00abce 0%, #73a535 100%);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .modal-history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grunin-branding {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 20px;
            }
            
            .grunin-logo-img {
                width: 200px;
            }
            
            .grunin-title {
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content-section {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .content-section h2 {
                font-size: 1.4em;
            }
            
            /* Map section same width as other sections */
            .map-section {
                margin-bottom: 20px;
            }
            
            /* Map height optimized for mobile */
            .map-content {
                height: 280px;  /* Reduced from 350px for better US aspect ratio */
            }
            
            /* Keep inset boxes in map, just reposition to avoid overlap */
            .alaska-box {
                bottom: 60px !important;
                left: 10px !important;
                top: auto !important;
            }
            
            .hawaii-box {
                bottom: 10px !important;
                left: 10px !important;
            }
            
            /* Map controls responsive */
            .controls-row {
                flex-direction: column;
                gap: 10px;
            }
            
            /* Make state badges smaller on mobile to prevent overlap */
            .state-badge-marker {
                transform: scale(0.8);  /* Slightly bigger for better clicking */
            }
            
            .state-badge {
                font-size: 10px !important;
                padding: 3px 6px !important;
            }
            
            .state-badge.northeast {
                font-size: 9px !important;
                padding: 2px 5px !important;
            }
            
            .control-group {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
            }
            
            select, button {
                width: auto;
                min-width: 120px;
            }
            
            .legend {
                flex-direction: column;
                gap: 8px;
            }
            
            /* Forms visualization responsive - make bars smaller to fit */
            .forms-section {
                padding: 15px;
            }
            
            .forms-content {
                padding: 10px;
            }
            
            .forms-visual {
                gap: 5px;
                padding: 10px 0;
                justify-content: center;
                display: flex;
                flex-wrap: nowrap;
                max-width: 100%;
                overflow: hidden;
            }
            
            .form-bar {
                flex: 1;
                max-width: 50px;
                min-width: 0;  /* Allow shrinking as needed */
            }
            
            .form-bar-wrapper {
                padding: 3px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-end;
                height: 100%;
            }
            
            .form-bar-label {
                font-size: 7px;  /* Smaller font for mobile */
                writing-mode: initial;  /* Keep horizontal */
                text-orientation: initial;
                padding: 3px 1px;
                text-align: center;
                line-height: 1.1;
                overflow: hidden;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .form-bar-count {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .form-bar-fill {
                width: 100%;
                max-width: 40px;
            }
            
            .form-bar-states {
                display: none;
            }
            
            .click-hint {
                display: none;
            }
            
            /* Modal adjustments for mobile */
            .state-modal {
                width: 95%;
                max-height: 90vh;
                margin: 20px;
            }
            
            .state-modal-header {
                padding: 15px 20px;
            }
            
            .state-modal-title {
                font-size: 1.5em;
            }
            
            .state-modal-body {
                padding: 20px;
            }
        }
        
        /* Smaller mobile screens */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .grunin-logo-img {
                width: 150px;
            }
            
            .grunin-name {
                font-size: 1.4em;
            }
            
            .grunin-subtitle {
                font-size: 1em;
            }
            
            /* Even more compact inset boxes on very small screens */
            .alaska-box, .hawaii-box {
                width: 60px;  /* Smaller and same size */
                height: 35px;
                padding: 5px;
            }
            
            .inset-state-badge {
                font-size: 12px;
                padding: 4px 10px;
            }
            
            /* Make form bars even smaller on small screens */
            .forms-section {
                padding: 10px;
            }
            
            .forms-visual {
                gap: 3px;
                overflow: hidden;  /* Prevent any overflow */
            }
            
            .form-bar {
                min-width: 0;
                max-width: 40px;
                flex: 1;
            }
            
            .form-bar-wrapper {
                padding: 2px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-end;
            }
            
            .form-bar-label {
                font-size: 6px;  /* Even smaller for tiny screens */
                padding: 2px 1px;
                line-height: 1.1;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .form-bar-count {
                font-size: 10px;
                margin-bottom: 2px;
            }
            
            .form-bar-fill {
                width: 100%;
                max-width: 35px;
            }
            
            .form-bar-states {
                display: none;
            }
        }
        
        .state-details-placeholder {
            color: #a0aec0;
            text-align: center;
            padding: 30px 20px;
        }
        
        .state-details-placeholder-icon {
            font-size: 36px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .state-details-placeholder h3 {
            font-size: 1.2em;
            color: #925333;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .state-details-placeholder p {
            color: #666;
            font-size: 14px;
        }
        
        /* State Details Styling when populated */
        .state-details {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            align-items: flex-start;
        }
        
        .state-header {
            flex: 0 0 auto;
            padding-right: 30px;
            border-right: 2px solid #e0e0e0;
        }
        
        .state-name {
            color: #925333;
            font-size: 1.6em;
            font-weight: 700;
            margin: 0 0 5px 0;
        }
        
        .state-subtitle {
            color: #666;
            font-size: 0.9em;
        }
        
        .detail-section {
            flex: 1;
            min-width: 200px;
        }
        
        .detail-title {
            color: #00abce;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .form-item {
            background: rgba(115,165,53,0.1);
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 0.9em;
            border-left: 3px solid #73a535;
        }
        
        .form-item.pending {
            background: rgba(255,193,7,0.1);
            border-left-color: #ffc107;
        }
        
        .form-item.failed {
            background: rgba(220,53,69,0.1);
            border-left-color: #dc3545;
        }
        
        .empty-state {
            color: #999;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .history-btn {
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .sidebar-placeholder h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
            color: #925333;
        }
        
        /* State Details */
        .state-details {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .state-header {
            border-bottom: 3px solid #00abce;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .state-name {
            color: #925333;
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .state-subtitle {
            color: #73a535;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .detail-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #73a535;
        }
        
        .detail-title {
            font-weight: 600;
            color: #925333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .form-list {
            list-style: none;
        }
        
        .form-item {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        
        .form-item:hover {
            border-color: #00abce;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-item.pending {
            background: #fff4e5;
            border-color: #ffa500;
        }
        
        .form-item.failed {
            background: #ffebee;
            border-color: #e74c3c;
        }
        
        .empty-state {
            color: #a0aec0;
            font-style: italic;
        }
        
        .history-btn {
            width: 100%;
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 12px;
            border: none;
            font-weight: 600;
        }
        
        .history-btn:hover {
            background: linear-gradient(135deg, #925333, #73a535);
        }
        
        /* Leader Lines for Northeast States */
        .leader-line {
            stroke: #333;
            stroke-width: 1.5;
            fill: none;
            opacity: 0.7;
            stroke-dasharray: 3,3;
        }
        
        /* Inset Boxes for Alaska and Hawaii */
        .inset-box {
            position: absolute;
            background: white;
            border: 2.5px solid #666;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .inset-box:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-color: #00abce;
        }
        
        .alaska-box {
            top: 20px;
            left: 20px;
            width: 85px;
            height: 50px;
        }
        
        .hawaii-box {
            bottom: 20px;
            left: 20px;
            width: 85px;
            height: 50px;
        }
        
        .inset-box.selected {
            border-color: #ff6b6b;
            border-width: 3px;
            background: #fff9f0;
        }
        
        /* Inset state label styling to match regular state badges */
        .inset-state-badge {
            background: white;
            border: 2px solid #73a535;
            border-radius: 20px;
            padding: 6px 14px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .inset-box:hover .inset-state-badge {
            border-color: #00abce;
            transform: scale(1.1);
        }
        
        .inset-box.selected .inset-state-badge {
            background: #ffebeb;
            border-color: #ff6b6b;
            border-width: 3px;
        }
        
        /* Small text above inset boxes */
        .inset-label-text {
            position: absolute;
            top: -18px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            color: #666;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .inset-box:hover .state-shape-path,
        .inset-box:hover .hawaii-island {
            fill: rgba(0,171,206,0.1);
        }
        
        .state-shape-path.selected,
        .hawaii-island.selected {
            fill: rgba(0,171,206,0.2);
            stroke: #00abce;
            stroke-width: 2;
        }
        
        .inset-state-label {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
            font-weight: 600;
            font-size: 12px;
            color: #333;
            background: rgba(255,255,255,0.95);
            padding: 2px 8px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            z-index: 10;
            white-space: nowrap;
        }
        
        /* State Badge Styles */
        .state-badge {
            background: white;
            padding: 5px 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 2px solid #00abce;
            white-space: nowrap;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .state-badge.selected {
            background: #00abce;
            color: white;
            border-color: #925333;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000 !important;
        }
        
        .state-badge.northeast {
            font-size: 11px;
            padding: 3px 6px;
        }
        
        .state-badge-marker {
            background: transparent !important;
            border: none !important;
            z-index: 400 !important;
        }
        
        .state-badge-marker.selected-marker {
            z-index: 1000 !important;
        }
        
        /* Stats Bar Section - Inside Map Box */
        .stats-bar {
            background: linear-gradient(to bottom, #f8f9fa, #ffffff);
            border-top: 2px solid #00abce;
            padding: 25px 30px;
            display: flex;
            align-items: stretch;
            gap: 40px;
            min-height: 180px;
            overflow: hidden;
            position: relative;
        }

        .stats-year-indicator {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            border-right: 2px solid rgba(0,171,206,0.2);
            min-width: 160px;
        }

        .year-badge {
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.8em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }

        .year-label {
            color: #925333;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            line-height: 1.2;
        }

        .forms-visual {
            flex: 1;
            display: flex;
            gap: 25px;
            align-items: flex-end;
            padding: 20px 0;
            justify-content: center;
            overflow: hidden;
            min-height: 140px;
        }
        
        /* Clickable Form Bar */
        .form-bar {
            flex: 1;
            max-width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .form-bar:hover {
            transform: translateY(-5px);
        }

        .form-bar-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: inherit;
        }

        .form-bar-count {
            background: #925333;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s ease;
        }

        .form-bar:hover .form-bar-count {
            background: #73a535;
        }

        .form-bar-fill {
            width: 60px;
            background: linear-gradient(180deg, #00abce, #73a535);
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            position: relative;
            min-height: 10px;
            box-shadow: 0 -2px 10px rgba(0,171,206,0.3);
        }

        .form-bar:hover .form-bar-fill {
            box-shadow: 0 -4px 20px rgba(0,171,206,0.5);
            background: linear-gradient(180deg, #00c4e8, #7fb53f);
        }

        .form-bar-label {
            background: rgba(146, 83, 51, 0.1);
            padding: 8px 15px;
            border-radius: 0 0 10px 10px;
            width: 100%;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            color: #925333;
            border: 2px solid rgba(146, 83, 51, 0.2);
            border-top: none;
            margin-top: -2px;
            transition: all 0.3s ease;
        }

        .form-bar:hover .form-bar-label {
            background: rgba(0, 171, 206, 0.1);
            border-color: rgba(0, 171, 206, 0.3);
        }

        .form-bar-states {
            font-size: 0.7em;
            color: #666;
            font-weight: 400;
            margin-top: 2px;
        }

        .click-hint {
            font-size: 0.65em;
            color: #00abce;
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .form-bar:hover .click-hint {
            opacity: 1;
        }
        
        /* Reports Section */
        .reports-content {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }

        .reports-main {
            flex: 2;
        }

        .reports-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            max-width: none;
        }

        .tepper-fellows-info {
            flex: 1;
            background: rgba(115, 165, 53, 0.1);
            border-radius: 15px;
            padding: 25px;
            border-left: 4px solid #73a535;
            min-width: 300px;
        }

        .tepper-fellows-info h3 {
            color: #925333;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            font-family: 'Montserrat', sans-serif;
        }

        .tepper-fellows-info p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
            font-family: 'Frank Ruhl Libre', serif;
            font-size: 1em;
        }

        .tepper-link {
            display: inline-block;
            color: #73a535;
            text-decoration: none;
            font-weight: 500;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95em;
            transition: color 0.3s ease;
        }

        .tepper-link:hover {
            color: #925333;
            text-decoration: underline;
        }

        .report-link {
            display: block;
            padding: 15px 20px;
            background: linear-gradient(135deg, #00abce, #73a535);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .report-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #925333, #73a535);
        }
        
        /* Acknowledgment Section */
        .acknowledgment {
            background: linear-gradient(135deg, #925333, #73a535);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .acknowledgment h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .acknowledgment p {
            color: rgba(255,255,255,0.95);
            font-style: italic;
        }
        
        /* Remove zoom controls from Leaflet */
        .leaflet-control-zoom {
            display: none !important;
        }
        
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .grunin-branding {
                flex-direction: column;
                text-align: center;
            }
            
            .grunin-title {
                text-align: center;
            }
            
            .grunin-logo-img {
                width: 200px;
            }
            
            .map-content {
                flex-direction: column;
                height: auto;
            }
            
            #map {
                height: 400px;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .reports-content {
                flex-direction: column;
            }
            
            .tepper-fellows-info {
                min-width: auto;
            }
            
            .stats-bar {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .alaska-box {
                top: 10px;
                left: 10px;
                width: 90px;
                height: 75px;
            }
            
            .hawaii-box {
                bottom: 10px;
                left: 10px;
                width: 90px;
                height: 55px;
            }
            
            .inset-state-label {
                font-size: 11px;
                padding: 1px 5px;
            }
            
            .stats-year-indicator {
                border-right: none;
                border-bottom: 2px solid rgba(0,171,206,0.2);
                padding-bottom: 20px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grunin-branding">
            <img src="https://socialenterprise.law.nyu.edu/wp-content/uploads/2022/07/grunin-homepage-logo-150x150.png" 
                 alt="Grunin Center Logo" 
                 class="grunin-logo-img">
            <div class="grunin-title">
                <div class="grunin-name">Grunin Center for Law and Social Entrepreneurship</div>
                <div class="grunin-subtitle">NYU School of Law</div>
            </div>
        </div>
        
        <div class="header">
            <h1>Social Enterprise Legislative Tracker</h1>
        </div>
        
        <!-- About Section -->
        <div class="content-section">
            <h2>About</h2>
            <p>Welcome to the Social Enterprise Law Tracker ("SELT"). Beginning in 2008, state legislatures started authorizing a new class of entities collectively known as <em>social enterprises</em>. These corporate and company forms are designed for businesses that seek to create positive social and environmental impacts in addition to financial returns. These forms include the benefit corporation (Benefit Corps), the social purpose corporation (SPC), the low-profit limited liability company (L3C), the benefit limited liability company (BLLC), and the statutory public benefit limited partnership (SPBLP).</p>
            
            <p>The SELT visualizes how social enterprise law has spread across the US. Select any state to see the social enterprise forms that are available, and historic legislative activity.</p>
            
            <p>The SELT was developed by Rob Esposito and Shawn Pelsinger, with support from the NYU Jacobson Leadership Program in Law & Business, the NYU Stern Business & Society Program, and the NYU Law and Social Entrepreneurship Association. The SELT is now hosted and maintained by the Grunin Center for Law and Social Entrepreneurship.</p>
        </div>
        
        <!-- Forms Definitions Section -->
        <div class="content-section">
            <h2>Social Enterprise Corporate Forms Defined</h2>
            <p>The SELT tracks the following five corporate forms, each designed to support businesses pursuing both profit and positive social or environmental impact:</p>
            
            <p><strong>Benefit Corporation (BCORP)</strong> is the most widely adopted form, requiring companies to pursue general public benefit alongside profit. Directors must consider stakeholder interests beyond shareholders in decision-making.</p>
            
            <p><strong>Social Purpose Corporation (SPC)</strong> allows corporations to define specific social or environmental purposes in addition to profit maximization. It provides flexibility in how companies balance financial and social objectives.</p>
            
            <p><strong>Low-profit Limited Liability Company (L3C)</strong> is designed primarily for charitable purposes with limited profit distribution. It was originally created to facilitate program-related investments (PRIs) by foundations.</p>
            
            <p><strong>Benefit Limited Liability Company (BLLC)</strong> combines the flexibility of LLC structure with benefit corporation principles. Currently available only in Delaware, it offers LLC tax treatment with social benefit requirements.</p>
            
            <p><strong>Social Purpose Benefit Limited Partnership (SPBLP)</strong> provides a limited partnership structure for social enterprises, particularly suited for impact investing. Also currently available only in Delaware for sophisticated investment arrangements.</p>
        </div>
        
        <div class="map-section">
            <div class="map-controls">
                <div class="controls-row">
                    <div class="control-group">
                        <span class="control-label">Year:</span>
                        <select id="yearSelect">
                            <!-- Will be populated by JS -->
                        </select>
                    </div>
                    <div class="legend" id="legend">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
            <div class="map-content">
                <div id="map"></div>
            </div>
            
            <!-- State Details Section (moved from sidebar) -->
            <div class="state-details-section" id="stateDetails">
                <div class="state-details-placeholder">
                    <div class="state-details-placeholder-icon">üìç</div>
                    <h3>Select a State</h3>
                    <p>Click on any state to view details</p>
                </div>
            </div>
            
            <!-- Stats Bar with Form Visualization -->
            <div class="stats-bar" id="statsBar">
                <div class="stats-year-indicator">
                    <div class="year-badge" id="yearBadge">2024</div>
                    <div class="year-label">Forms Active in This Year</div>
                </div>
                
                <div class="forms-visual" id="formsVisual">
                    <!-- Form bars will be dynamically populated -->
                </div>
            </div>
        </div>
        
        <!-- Reports Section -->
        <div class="content-section">
            <div class="reports-content">
                <div class="reports-main">
                    <h2>Annual Reports: The State of Social Enterprise and the Law</h2>
                    <p>The Grunin Center publishes comprehensive annual reports tracking US social enterprise legislative developments from 2009 to the present.</p>
                    
                    <div class="reports-grid">
                        <a href="https://www.law.nyu.edu/centers/grunin-social-entrepreneurship/resources/publications" target="_blank" class="report-link">
                            üìä Access All Reports and Publications
                        </a>
                    </div>
                </div>
                
                <div class="tepper-fellows-info">
                    <h3>About the Tepper Fellows</h3>
                    <p>Each year, the Grunin Center selects up to five student Research Assistants as Tepper Fellows. These Fellows maintain the Social Enterprise Law Tracker and author the annual reports.</p>
                    <a href="https://www.law.nyu.edu/centers/grunin-social-entrepreneurship/courses-programs/tepper-fellows" target="_blank" class="tepper-link">
                        Learn more about our current Tepper Fellows ‚Üí
                    </a>
                </div>
            </div>
            
            <div class="acknowledgment">
                <h3>Acknowledgment</h3>
                <p>This research project is generously funded by the Tepper Family. We would like to extend our gratitude to the Tepper Family, with particular thanks to Marvin Tepper '58, Elise Tepper, Jacqueline Tepper '90, Edward Tepper, and Shelley Tepper.</p>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // State names mapping
        const stateNames = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };
        
        // Legislative Data (from your original file)
        const legislativeData = {
          "2008": {
            "VT": { "forms": ["L3C"], "failed": [], "rescinded": [] }
          },
          
          "2009": {
            "VT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "MI": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "WY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "UT": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "IL": { "forms": ["L3C"], "failed": [], "rescinded": [] }
          },
          
          "2010": {
            "MD": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "NC": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "LA": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "ME": { "forms": ["L3C"], "failed": [], "rescinded": [] }
          },
          
          "2011": {
            "NJ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "VA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "HI": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "CA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
            "RI": { "forms": ["L3C"], "failed": [], "rescinded": [] }
          },
          
          "2012": {
            "NY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "CA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "WA": { "forms": ["SPC"], "failed": [], "rescinded": [] },
            "LA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "SC": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "MA": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2013": {
            "DE": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "CO": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "AR": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "KY": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "PA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "IL": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "RI": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2014": {
            "AZ": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "CO": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "CT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "DE": { "forms": ["BLLC"], "failed": [], "rescinded": [] },
            "FL": { "forms": ["SPC", "BCORP"], "failed": [], "rescinded": [] },
            "NE": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "NV": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "NH": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "OR": { "forms": ["BCORP", "BLLC"], "failed": [], "rescinded": [] },
            "UT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "WV": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2015": {
            "ID": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "IN": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "MN": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "MT": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "TN": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2016": {
            "PA": { "forms": ["BLLC"], "failed": [], "rescinded": [] }
          },
          
          "2017": {
            "KS": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "KY": { "forms": ["L3C"], "failed": [], "rescinded": [] },
            "TX": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "WI": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2018": {
            "DE": { "forms": ["SPBLP"], "failed": [], "rescinded": [] },
            "UT": { "forms": ["BLLC"], "failed": [], "rescinded": [] }
          },
          
          "2019": {
            "ME": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "OK": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2020": {
            "AL": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "GA": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "NM": { "forms": ["BCORP"], "failed": [], "rescinded": [] },
            "OH": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2021": {
            "IA": { "forms": ["BCORP"], "failed": [], "rescinded": [] }
          },
          
          "2023": {
            "MI": { "forms": [], "failed": [], "rescinded": [], "underConsideration": ["BCORP"] }
          },
          
          "2024": {
            "MI": { "forms": [], "failed": [], "rescinded": [], "underConsideration": ["BCORP"] },
            "MS": { "forms": [], "failed": ["BCORP"], "rescinded": [] }
          }
        };
        
        // Corporate form definitions
        const corporateForms = {
          "SPC": "Social Purpose Corporation",
          "L3C": "Low-profit Limited Liability Company", 
          "BLLC": "Benefit Limited Liability Company",
          "SPBLP": "Social Purpose Benefit Limited Partnership",
          "BCORP": "Benefit Corporation"
        };
        
        // Helper functions
        function calculateAvailableForms(stateCode, targetYear) {
            const availableForms = new Set();
            
            for (let year = 2008; year <= parseInt(targetYear); year++) {
                const yearData = legislativeData[year.toString()];
                if (yearData && yearData[stateCode]) {
                    const stateData = yearData[stateCode];
                    
                    stateData.forms.forEach(form => availableForms.add(form));
                    stateData.rescinded.forEach(form => availableForms.delete(form));
                }
            }
            
            return Array.from(availableForms);
        }
        
        function getStateActivity(stateCode, year) {
            const yearData = legislativeData[year.toString()];
            if (!yearData || !yearData[stateCode]) {
                return { 
                    status: "none", 
                    emoji: "‚ö™", 
                    forms: [], 
                    failed: [], 
                    rescinded: [],
                    underConsideration: [],
                    availableForms: calculateAvailableForms(stateCode, year)
                };
            }
            
            const stateData = yearData[stateCode];
            const formsCount = stateData.forms.length;
            const failedCount = stateData.failed.length;
            const rescindedCount = stateData.rescinded.length;
            const underConsiderationCount = stateData.underConsideration ? stateData.underConsideration.length : 0;
            
            let status, emoji;
            
            if (rescindedCount > 0) {
                status = "rescinded";
                emoji = "‚õî";
            } else if (failedCount > 0 && formsCount === 0 && underConsiderationCount === 0) {
                status = "failed";
                emoji = "‚ùå";
            } else if (formsCount > 0) {
                status = "enacted";
                emoji = "‚úÖ";
            } else if (underConsiderationCount > 0) {
                status = "underConsideration";
                emoji = "‚è≥";
            } else {
                status = "none";
                emoji = "‚ö™";
            }
            
            return {
                status: status,
                emoji: emoji,
                forms: stateData.forms,
                failed: stateData.failed,
                rescinded: stateData.rescinded,
                underConsideration: stateData.underConsideration || [],
                availableForms: calculateAvailableForms(stateCode, year)
            };
        }
        
        // State coordinates
        const stateCoordinates = {
            'AL': [32.806671, -86.791130], 'AK': [61.370716, -152.404419], 'AZ': [33.729759, -111.431221],
            'AR': [34.969704, -92.373123], 'CA': [36.116203, -119.681564], 'CO': [39.059811, -105.311104],
            'CT': [41.597782, -72.755371], 'DE': [39.318523, -75.507141], 'FL': [27.766279, -81.686783],
            'GA': [33.040619, -83.643074], 'HI': [21.094318, -157.498337], 'ID': [44.240459, -114.478828],
            'IL': [40.349457, -88.986137], 'IN': [39.849426, -86.258278], 'IA': [42.011539, -93.210526],
            'KS': [38.526600, -96.726486], 'KY': [37.668140, -84.670067], 'LA': [31.169546, -91.867805],
            'ME': [44.693947, -69.381927], 'MD': [39.063946, -76.802101], 'MA': [42.230171, -71.530106],
            'MI': [43.326618, -84.536095], 'MN': [45.694454, -93.900192], 'MS': [32.741646, -89.678696],
            'MO': [38.456085, -92.288368], 'MT': [46.921925, -110.454353], 'NE': [41.125370, -98.268082],
            'NV': [38.313515, -117.055374], 'NH': [43.452492, -71.563896], 'NJ': [40.298904, -74.521011],
            'NM': [34.840515, -106.248482], 'NY': [42.165726, -74.948051], 'NC': [35.630066, -79.806419],
            'ND': [47.528912, -99.784012], 'OH': [40.388783, -82.764915], 'OK': [35.565342, -96.928917],
            'OR': [44.572021, -122.070938], 'PA': [40.590752, -77.209755], 'RI': [41.680893, -71.511780],
            'SC': [33.856892, -80.945007], 'SD': [44.299782, -99.438828], 'TN': [35.747845, -86.692345],
            'TX': [31.054487, -97.563461], 'UT': [40.150032, -111.862434], 'VT': [44.045876, -72.710686],
            'VA': [37.769337, -78.169968], 'WA': [47.400902, -121.490494], 'WV': [38.491226, -80.954456],
            'WI': [44.268543, -89.616508], 'WY': [42.755966, -107.302490]
        };
        
        class EnhancedSELTMap {
            constructor() {
                this.map = null;
                this.stateMarkers = new Map();
                this.selectedState = null;
                this.currentYear = '2024';
                this.originalView = null;
                
                this.initMap();
                this.createStateMarkers();
                this.setupControls();
                this.updateDisplay();
            }
            
            initMap() {
                // Detect if mobile
                const isMobile = window.innerWidth <= 768;
                
                // For mobile: zoom in more to focus on US, less Canada/Mexico
                // Zoom in to reduce visible borders
                const mapCenter = isMobile ? [39, -96.5] : [38.5, -98.5795];
                const mapZoom = isMobile ? 3.8 : 4;  // More zoomed in on mobile
                
                // Initialize map with locked view
                this.map = L.map('map', {
                    center: mapCenter,
                    zoom: mapZoom,
                    zoomControl: false, // Disable zoom controls
                    scrollWheelZoom: false, // Disable scroll zoom
                    doubleClickZoom: false, // Disable double click zoom
                    touchZoom: false, // Disable touch zoom
                    boxZoom: false, // Disable box zoom
                    keyboard: false, // Disable keyboard navigation
                    dragging: false // Disable map dragging - no scrolling!
                });
                
                // Store original view
                this.originalView = {
                    center: mapCenter,
                    zoom: mapZoom
                };
                
                // Simple tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ''
                }).addTo(this.map);
                
                // On mobile, ensure map fits properly
                if (isMobile) {
                    setTimeout(() => {
                        this.map.invalidateSize();
                    }, 100);
                }
            }
            
            createStateMarkers() {
                // Detect mobile for different positioning
                const isMobile = window.innerWidth <= 768;
                
                // Northeast states with maximum spacing to prevent any overlap
                // On mobile, push callouts even further out
                const northeastStates = {
                    'ME': { actual: [44.693947, -69.381927], callout: isMobile ? [47.5, -62] : [46.5, -64.5] },
                    'NH': { actual: [43.452492, -71.563896], callout: isMobile ? [46.5, -64] : [45, -66] },
                    'VT': { actual: [44.045876, -72.710686], callout: isMobile ? [45.5, -66] : [44, -68] },
                    'MA': { actual: [42.230171, -71.530106], callout: isMobile ? [43.5, -63] : [42.5, -65] },
                    'RI': { actual: [41.680893, -71.511780], callout: isMobile ? [42, -64.5] : [41, -66.5] },
                    'CT': { actual: [41.597782, -72.755371], callout: isMobile ? [41, -66.5] : [40, -68.5] },
                    'NJ': { actual: [40.298904, -74.521011], callout: isMobile ? [39.5, -68.5] : [38.8, -70.5] },
                    'DE': { actual: [39.318523, -75.507141], callout: isMobile ? [38, -70] : [37.5, -72] },
                    'MD': { actual: [39.063946, -76.802101], callout: isMobile ? [37, -72] : [36.5, -74] }
                };
                
                // Create leader lines for Northeast states
                Object.entries(northeastStates).forEach(([stateCode, positions]) => {
                    // Create the leader line with better visibility
                    const line = L.polyline([positions.actual, positions.callout], {
                        color: '#333',
                        weight: 1.5,
                        opacity: 0.7,
                        dashArray: '3, 3',
                        className: 'leader-line'
                    }).addTo(this.map);
                    
                    // Create the state badge at the callout position
                    const marker = L.marker(positions.callout, {
                        icon: this.createStateBadge(stateCode, true)
                    }).addTo(this.map);
                    
                    // Click handler
                    marker.on('click', () => {
                        // Reset all marker z-indexes first
                        this.stateMarkers.forEach((m, code) => {
                            m.setZIndexOffset(0);
                        });
                        
                        if (this.selectedState === stateCode) {
                            this.selectedState = null;
                            marker.setZIndexOffset(0);
                        } else {
                            this.selectedState = stateCode;
                            // Bring selected marker to front
                            marker.setZIndexOffset(1000);
                            
                            // Show modal with state details
                            const stateName = stateNames[stateCode];
                            const activity = getStateActivity(stateCode, this.currentYear);
                            showStateModal(stateCode, stateName, activity, this.currentYear);
                        }
                        this.updateDisplay();
                        this.updateFormBars();
                    });
                    
                    this.stateMarkers.set(stateCode, marker);
                });
                
                // Create regular markers for other states (excluding AK and HI)
                Object.entries(stateCoordinates).forEach(([stateCode, coords]) => {
                    // Skip Northeast states, Alaska, and Hawaii
                    if (northeastStates[stateCode] || stateCode === 'AK' || stateCode === 'HI') {
                        return;
                    }
                    
                    const marker = L.marker(coords, {
                        icon: this.createStateBadge(stateCode, false)
                    }).addTo(this.map);
                    
                    // Click handler
                    marker.on('click', () => {
                        // Reset all marker z-indexes first
                        this.stateMarkers.forEach((m, code) => {
                            m.setZIndexOffset(0);
                        });
                        
                        if (this.selectedState === stateCode) {
                            this.selectedState = null;
                            marker.setZIndexOffset(0);
                        } else {
                            this.selectedState = stateCode;
                            // Bring selected marker to front
                            marker.setZIndexOffset(1000);
                            
                            // Show modal with state details
                            const stateName = stateNames[stateCode];
                            const activity = getStateActivity(stateCode, this.currentYear);
                            showStateModal(stateCode, stateName, activity, this.currentYear);
                        }
                        this.updateDisplay();
                        this.updateFormBars();
                    });
                    
                    this.stateMarkers.set(stateCode, marker);
                });
                
                // Create inset boxes for Alaska and Hawaii
                this.createInsetBoxes();
            }
            
            createInsetBoxes() {
                const mapContainer = document.getElementById('map');
                
                // Create Alaska inset box with simple text badge
                const alaskaBox = document.createElement('div');
                alaskaBox.className = 'inset-box alaska-box';
                alaskaBox.innerHTML = `
                    <div class="inset-state-badge" id="alaska-label">AK ‚ö™</div>
                `;
                mapContainer.appendChild(alaskaBox);
                
                // Create Hawaii inset box with simple text badge  
                const hawaiiBox = document.createElement('div');
                hawaiiBox.className = 'inset-box hawaii-box';
                hawaiiBox.innerHTML = `
                    <div class="inset-state-badge" id="hawaii-label">HI ‚ö™</div>
                `;
                mapContainer.appendChild(hawaiiBox);
                
                // Add click handlers for Alaska
                const alaskaElement = document.querySelector('.alaska-box');
                alaskaElement.addEventListener('click', () => {
                    if (this.selectedState === 'AK') {
                        this.selectedState = null;
                    } else {
                        this.selectedState = 'AK';
                        // Show modal with state details
                        const stateName = stateNames['AK'];
                        const activity = getStateActivity('AK', this.currentYear);
                        showStateModal('AK', stateName, activity, this.currentYear);
                    }
                    this.updateDisplay();
                    this.updateFormBars();
                    this.updateInsetBoxes();
                });
                
                // Add click handler for Hawaii
                const hawaiiElement = document.querySelector('.hawaii-box');
                hawaiiElement.addEventListener('click', () => {
                    if (this.selectedState === 'HI') {
                        this.selectedState = null;
                    } else {
                        this.selectedState = 'HI';
                        // Show modal with state details
                        const stateName = stateNames['HI'];
                        const activity = getStateActivity('HI', this.currentYear);
                        showStateModal('HI', stateName, activity, this.currentYear);
                    }
                    this.updateDisplay();
                    this.updateFormBars();
                    this.updateInsetBoxes();
                });
                
                // Store references for updating
                this.alaskaLabel = document.getElementById('alaska-label');
                this.hawaiiLabel = document.getElementById('hawaii-label');
            }
            
            updateInsetBoxes() {
                // Update Alaska
                const akActivity = getStateActivity('AK', this.currentYear);
                this.alaskaLabel.textContent = `AK ${akActivity.emoji}`;
                
                const alaskaBox = document.querySelector('.alaska-box');
                if (this.selectedState === 'AK') {
                    alaskaBox.classList.add('selected');
                } else {
                    alaskaBox.classList.remove('selected');
                }
                
                // Update Hawaii
                const hiActivity = getStateActivity('HI', this.currentYear);
                this.hawaiiLabel.textContent = `HI ${hiActivity.emoji}`;
                
                const hawaiiBox = document.querySelector('.hawaii-box');
                if (this.selectedState === 'HI') {
                    hawaiiBox.classList.add('selected');
                } else {
                    hawaiiBox.classList.remove('selected');
                }
            }
            
            setupControls() {
                // Populate year dropdown
                const yearSelect = document.getElementById('yearSelect');
                for (let year = 2024; year >= 2008; year--) {
                    const option = document.createElement('option');
                    option.value = year.toString();
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                
                yearSelect.addEventListener('change', (e) => {
                    this.currentYear = e.target.value;
                    this.updateDisplay();
                    this.updateFormBars();
                    // Update year badge
                    document.getElementById('yearBadge').textContent = this.currentYear;
                });
                
                // Initialize displays
                this.updateLegend();
                this.updateFormBars();
            }
            
            createStateBadge(stateCode, isNortheast = false) {
                let className = isNortheast ? 'state-badge northeast' : 'state-badge';
                let markerClassName = 'state-badge-marker';
                
                if (this.selectedState === stateCode) {
                    className += ' selected';
                    markerClassName += ' selected-marker';
                }
                
                const activity = getStateActivity(stateCode, this.currentYear);
                const html = `<div class="${className}">${stateCode} ${activity.emoji}</div>`;
                return L.divIcon({
                    html: html,
                    iconSize: null,
                    className: markerClassName
                });
            }
            
            updateDisplay() {
                // Update regular state markers
                this.stateMarkers.forEach((marker, code) => {
                    // Skip Alaska and Hawaii as they're handled by inset boxes
                    if (code === 'AK' || code === 'HI') {
                        return;
                    }
                    // Determine if state is in northeast
                    const northeastStates = ['ME', 'CT', 'DE', 'MD', 'MA', 'NH', 'NJ', 'RI', 'VT'];
                    const isNortheast = northeastStates.includes(code);
                    marker.setIcon(this.createStateBadge(code, isNortheast));
                    
                    // Manage z-index - bring selected state to front
                    if (this.selectedState === code) {
                        marker.setZIndexOffset(1000);
                    } else {
                        marker.setZIndexOffset(0);
                    }
                });
                
                // Update inset boxes if they exist
                if (this.alaskaLabel && this.hawaiiLabel) {
                    this.updateInsetBoxes();
                }
            }
            
            updateSidebar() {
                const stateDetails = document.getElementById('stateDetails');
                
                if (!this.selectedState) {
                    stateDetails.innerHTML = `
                        <div class="state-details-placeholder">
                            <div class="state-details-placeholder-icon">üìç</div>
                            <h3>Select a State</h3>
                            <p>Click on any state to view details</p>
                        </div>
                    `;
                    return;
                }
                
                const stateName = stateNames[this.selectedState];
                const activity = getStateActivity(this.selectedState, this.currentYear);
                
                stateDetails.innerHTML = `
                    <div class="state-details">
                        <div class="state-header">
                            <h2 class="state-name">${stateName}</h2>
                            <div class="state-subtitle">Activity in ${this.currentYear}</div>
                        </div>
                        
                        ${activity.forms && activity.forms.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-title">Enacted This Year</div>
                                <ul class="form-list">
                                    ${activity.forms.map(form => `
                                        <li class="form-item">${corporateForms[form] || form}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${activity.underConsideration && activity.underConsideration.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-title">Under Consideration</div>
                                <ul class="form-list">
                                    ${activity.underConsideration.map(form => `
                                        <li class="form-item pending">${corporateForms[form] || form}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${activity.failed && activity.failed.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-title">Failed This Year</div>
                                <ul class="form-list">
                                    ${activity.failed.map(form => `
                                        <li class="form-item failed">${corporateForms[form] || form}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <div class="detail-title">Currently Available Forms</div>
                            ${activity.availableForms.length > 0 ? `
                                <ul class="form-list">
                                    ${activity.availableForms.map(form => `
                                        <li class="form-item">${corporateForms[form] || form}</li>
                                    `).join('')}
                                </ul>
                            ` : '<p class="empty-state">No forms currently available</p>'}
                        </div>
                        
                        <div class="detail-section">
                            <button onclick="window.open('states/${this.selectedState.toLowerCase()}.html', '_blank')" 
                                    class="history-btn">
                                üìú View Complete Legislative History
                            </button>
                        </div>
                    </div>
                `;
            }
            
            updateLegend() {
                const legend = document.getElementById('legend');
                
                legend.innerHTML = `
                    <div class="legend-item">
                        <span style="font-size: 16px;">‚ö™</span>
                        <span>No Activity</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 16px;">‚úÖ</span>
                        <span>Enacted Form(s)</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 16px;">‚ùå</span>
                        <span>Failed Legislation</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 16px;">‚è≥</span>
                        <span>Under Consideration</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 16px;">‚õî</span>
                        <span>Repealed</span>
                    </div>
                `;
            }
            
            updateFormBars() {
                const allStates = Array.from(this.stateMarkers.keys());
                
                // Count states for each form type in the current year
                const formCounts = {};
                
                allStates.forEach(stateCode => {
                    const activity = getStateActivity(stateCode, this.currentYear);
                    activity.availableForms.forEach(form => {
                        if (!formCounts[form]) {
                            formCounts[form] = 0;
                        }
                        formCounts[form]++;
                    });
                });

                // Sort forms by count
                const sortedForms = Object.entries(formCounts).sort((a, b) => b[1] - a[1]);
                
                // Create visual bars
                const formsVisual = document.getElementById('formsVisual');
                formsVisual.innerHTML = '';
                
                if (sortedForms.length === 0) {
                    formsVisual.innerHTML = '<div style="color: #999; font-style: italic;">No forms available in ' + this.currentYear + '</div>';
                } else {
                    const maxCount = sortedForms[0][1];
                    
                    sortedForms.forEach(([formCode, count]) => {
                        const height = Math.max(10, (count / maxCount) * 110);
                        const stateText = count === 1 ? '1 state' : `${count} states`;
                        
                        const formBar = document.createElement('div');
                        formBar.className = 'form-bar';
                        formBar.dataset.formtype = formCode;
                        formBar.onclick = () => {
                            window.location.href = `forms/${formCode.toLowerCase()}.html`;
                        };
                        
                        formBar.innerHTML = `
                            <div class="form-bar-wrapper">
                                <div class="form-bar-count">${count}</div>
                                <div class="form-bar-fill" style="height: ${height}px;"></div>
                                <div class="form-bar-label">
                                    ${formCode}
                                    <div class="form-bar-states">${stateText}</div>
                                    <div class="click-hint">Click for timeline ‚Üí</div>
                                </div>
                            </div>
                        `;
                        
                        formsVisual.appendChild(formBar);
                    });
                }
            }
        }
        
        // Modal Functions
        function showStateModal(stateCode, stateName, activity, year) {
            // Update modal header
            document.getElementById('modalStateName').textContent = stateName;
            document.getElementById('modalStateYear').textContent = `Activity in ${year}`;
            
            // Generate modal body content
            let bodyHTML = '';
            
            // Enacted forms section
            if (activity.forms && activity.forms.length > 0) {
                bodyHTML += `
                    <div class="modal-detail-section">
                        <div class="modal-detail-title">‚úÖ Enacted This Year</div>
                        <ul class="modal-form-list">`;
                activity.forms.forEach(form => {
                    const formName = corporateForms[form] || form;
                    bodyHTML += `<li class="modal-form-item">${formName}</li>`;
                });
                bodyHTML += `</ul></div>`;
            }
            
            // Under consideration section
            if (activity.underConsideration && activity.underConsideration.length > 0) {
                bodyHTML += `
                    <div class="modal-detail-section">
                        <div class="modal-detail-title">‚è≥ Under Consideration</div>
                        <ul class="modal-form-list">`;
                activity.underConsideration.forEach(form => {
                    const formName = corporateForms[form] || form;
                    bodyHTML += `<li class="modal-form-item pending">${formName}</li>`;
                });
                bodyHTML += `</ul></div>`;
            }
            
            // Failed legislation section
            if (activity.failed && activity.failed.length > 0) {
                bodyHTML += `
                    <div class="modal-detail-section">
                        <div class="modal-detail-title">‚ùå Failed This Year</div>
                        <ul class="modal-form-list">`;
                activity.failed.forEach(form => {
                    const formName = corporateForms[form] || form;
                    bodyHTML += `<li class="modal-form-item failed">${formName}</li>`;
                });
                bodyHTML += `</ul></div>`;
            }
            
            // Currently available forms section
            bodyHTML += `
                <div class="modal-detail-section">
                    <div class="modal-detail-title">üìã Currently Available Forms</div>`;
            
            if (activity.availableForms && activity.availableForms.length > 0) {
                bodyHTML += `<ul class="modal-form-list">`;
                activity.availableForms.forEach(form => {
                    const formName = corporateForms[form] || form;
                    bodyHTML += `<li class="modal-form-item">${formName}</li>`;
                });
                bodyHTML += `</ul>`;
            } else {
                bodyHTML += `<p class="modal-empty-state">No forms currently available</p>`;
            }
            bodyHTML += `</div>`;
            
            // View complete history button
            bodyHTML += `
                <div class="modal-detail-section">
                    <button onclick="window.open('states/${stateCode.toLowerCase()}.html', '_blank')" 
                            class="modal-history-btn">
                        üìú View Complete Legislative History
                    </button>
                </div>`;
            
            // Update modal body
            document.getElementById('modalStateBody').innerHTML = bodyHTML;
            
            // Show modal
            document.getElementById('stateModalOverlay').classList.add('show');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeStateModal() {
            document.getElementById('stateModalOverlay').classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            const seltMap = new EnhancedSELTMap();
            
            // Handle window resize for mobile responsiveness
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (seltMap.map) {
                        seltMap.map.invalidateSize();
                    }
                }, 250);
            });
            
            // Modal event listeners
            document.getElementById('stateModalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeStateModal();
                }
            });
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeStateModal();
            }
        });
    </script>
    
    <!-- Modal for State Details -->
    <div id="stateModalOverlay" class="state-modal-overlay">
        <div class="state-modal">
            <div class="state-modal-header">
                <div>
                    <div class="state-modal-title" id="modalStateName">State Name</div>
                    <div class="state-modal-year" id="modalStateYear">Activity in 2024</div>
                </div>
                <button class="state-modal-close" onclick="closeStateModal()" aria-label="Close">√ó</button>
            </div>
            <div class="state-modal-body" id="modalStateBody">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>
    
</body>
</html>